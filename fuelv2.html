<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ù„Ù„ Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ 2 | Smart Fuel Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
         :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e67e22;
            /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ù…ÙŠØ² */
            --bg-body: #f4f6f7;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            user-select: none;
            /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ */
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        /* --- Header --- */
        
        header {
            background: var(--bg-card);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 4px solid var(--accent-color);
        }
        
        .logo-box,
        .profile-box {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-box img {
            max-width: 100%;
            height: 140%;
        }
        
        .profile-box img {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            padding: 2px;
        }
        
        .header-content {
            text-align: center;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            color: var(--primary-color);
        }
        
        .copyright {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        .visitor-counter {
            background: var(--primary-color);
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 8px;
            display: inline-block;
        }
        /* --- Settings Panel (Accordion) --- */
        
        .settings-panel {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        details {
            padding: 0;
        }
        
        summary {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: bold;
            background: linear-gradient(to left, var(--bg-card), #ecf0f1);
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        summary::after {
            content: 'â–¼';
            font-size: 12px;
            transition: 0.3s;
        }
        
        details[open] summary::after {
            transform: rotate(180deg);
        }
        
        .settings-content {
            padding: 20px;
            border-top: 1px solid #eee;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .setting-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .setting-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }
        
        .setting-item input[type="checkbox"] {
            margin-left: 10px;
            transform: scale(1.2);
        }
        
        .setting-item input[type="number"],
        .setting-item input[type="text"] {
            margin-top: 8px;
            width: 90%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: none;
            /* Hidden by default */
        }
        /* Show input when checkbox is checked */
        
        .setting-item.active input[type="number"],
        .setting-item.active input[type="text"] {
            display: block;
        }
        
        .note {
            font-size: 0.8em;
            color: #7f8c8d;
            display: block;
            margin-top: 4px;
        }
        /* --- Drop Zone --- */
        
        .drop-zone {
            border: 3px dashed #bdc3c7;
            background: #fafafa;
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
            height: 7em;
        }
        
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--accent-color);
            background: #fdf2e9;
        }
        
        .drop-text {
            font-size: 1.2em;
            color: #7f8c8d;
        }
        /* --- Button --- */
        
        .btn-process {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 0 #1a252f;
        }
        
        .btn-process:hover {
            background: var(--secondary-color);
        }
        
        .btn-process:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .btn-process:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* --- Console --- */
        
        .console {
            background: #2d3436;
            color: #00b894;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            height: 250px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-entry {
            border-bottom: 1px solid #444;
            padding: 4px 0;
        }
        
        .log-error {
            color: #ff7675;
        }
        
        .log-info {
            color: #74b9ff;
        }
        
        .log-success {
            color: #55efc4;
            font-weight: bold;
        }
        /* --- Footer --- */
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: var(--text-light);
            font-size: 14px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="logo-box">
                <img src="https://talalcer.github.io/fuel-img/mizan.png" alt="Logo">
            </div>
            <div class="header-content">
                <h1 class="app-title">Ù…Ø­Ù„Ù„ Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ 2</h1>
                <div class="copyright">(c) Ø·Ù„Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØªÙŠ talalcer@gmail.com</div>
                <div id="visitorBadge" class="visitor-counter">Ø§Ù„Ø²ÙˆØ§Ø±: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
            <div class="profile-box">
                <img src="https://talalcer.github.io/fuel-img/talal512.png" alt="Talal">
            </div>
        </header>

        <div class="settings-panel">
            <details open>
                <summary>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø§Ù„Ø¥Ø®ÙØ§Ø¡)</summary>
                <div class="settings-content">
                    <div class="setting-item" id="optMinutes">
                        <label>
                        <input type="checkbox" id="chkMinutes">
                        ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ±Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„ØµØ±Ù Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                    </label>
                        <div class="note">ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
                        <input type="number" id="valMinutes" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ù…Ø«Ù„Ø§Ù‹ 60)">
                    </div>

                    <div class="setting-item" id="optQty">
                        <label>
                        <input type="checkbox" id="chkQty">
                        ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…ÙŠØ© ØµØ±Ù Ù…Ø­Ø¯Ø¯Ø©
                    </label>
                        <div class="note">ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ…ÙŠØ© 50</div>
                        <input type="number" id="valQty" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©">
                    </div>

                    <div class="setting-item">
                        <label>
                        <input type="checkbox" id="chkHoliday">
                        ÙŠÙˆØ¬Ø¯ Ø´ÙŠØª Ø§Ø¬Ø§Ø²Ø§Øª Ø±Ø³Ù…ÙŠØ© Ø¨Ø§Ù„Ù…Ù„Ù
                    </label>
                        <div class="note">ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
                    </div>

                    <div class="setting-item">
                        <label>
                        <input type="checkbox" id="chkTank">
                        ÙŠÙˆØ¬Ø¯ Ø´ÙŠØª Ø³Ø¹Ø© Ø§Ù„Ø®Ø²Ø§Ù† (ØªØ§Ù†Ùƒ) Ø¨Ø§Ù„Ù…Ù„Ù
                    </label>
                        <div class="note">Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¬Ø§ÙˆØ² Ø³Ø¹Ø© Ø§Ù„ØªØ§Ù†Ùƒ- Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… Ø§Ù„ØªØ¬Ø§Ù‡Ù„</div>
                    </div>

                    <div class="setting-item">
                        <label>
                        <input type="checkbox" id="chkDivinat">
                        ÙŠÙˆØ¬Ø¯ Ø´ÙŠØª ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªÙƒÙ‡ÙŠÙ† Ø§Ùˆ Ø§Ù„Ø§Ø¹Ø§Ø±Ø© Ø¨Ø§Ù„Ù…Ù„Ù
                    </label>
                        <div class="note">Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ±Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªÙƒÙ‡ÙŠÙ†- Ø¹Ø¯Ù… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… Ø§Ù„ØªØ¬Ø§Ù‡Ù„</div>
                    </div>
                </div>
            </details>
        </div>

        <div class="drop-zone" id="dropZone">
            <div class="drop-text">ğŸ“‚ Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ Ù‡Ù†Ø§</div>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
        </div>

        <button class="btn-process" id="btnProcess">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ ğŸš€</button>

        <div class="console" id="logConsole">
            <div class="log-entry">[System] Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„...</div>
        </div>

        <footer>
            ØªØµÙ…ÙŠÙ…: Ø·Ù„Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØªÙŠ (c) | Talal Cerity 2025
        </footer>
    </div>

    <script>
        /**
         * ==========================================
         * 1. SECURITY & CONFIG MODULE
         * ==========================================
         */
        class AppConfig {
            static init() {
                // Prevent Context Menu & F12
                document.addEventListener('contextmenu', e => e.preventDefault());
                document.addEventListener('keydown', e => {
                    if (e.key == 'F12' || (e.ctrlKey && e.shiftKey && e.key == 'I')) {
                        e.preventDefault();
                    }
                });

                // PWA Manifest Injection (Fixed for Blob/Localhost issues)
                const manifest = {
                    "name": "Ù…Ø­Ù„Ù„ Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ 2",
                    "short_name": "FuelAnalyzer2",
                    "start_url": window.location.href, // FIX: Use current location
                    "display": "standalone",
                    "theme_color": "#2c3e50",
                    "background_color": "#f4f6f7",
                    "icons": [{
                        "src": "https://talalcer.github.io/fuel-img/talal512.png",
                        "sizes": "192x192",
                        "type": "image/png"
                    }]
                };
                const link = document.createElement('link');
                link.rel = 'manifest';
                link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {
                    type: 'application/json'
                }));
                document.head.appendChild(link);

                // Fetch Visitor Count
                this.fetchVisitorCount();

                // UI Toggles
                this.setupUIToggles();
            }

            static async fetchVisitorCount() {
                const badge = document.getElementById('visitorBadge');
                try {
                    const response = await fetch('https://talalcer.github.io/visitor.json');
                    if (response.ok) {
                        const data = await response.json();
                        let count = localStorage.getItem('sfa_visitors') || data.count || 1000;
                        count = parseInt(count) + 1;
                        localStorage.setItem('sfa_visitors', count);
                        badge.innerText = `Ø§Ù„Ø²ÙˆØ§Ø±: ${count}`;
                    } else {
                        throw new Error("Network response was not ok");
                    }
                } catch (error) {
                    badge.innerText = "Ø§Ù„Ø²ÙˆØ§Ø±: 1205"; // Fallback
                }
            }

            static setupUIToggles() {
                ['chkMinutes', 'chkQty'].forEach(id => {
                    const chk = document.getElementById(id);
                    chk.addEventListener('change', () => {
                        chk.parentElement.parentElement.classList.toggle('active', chk.checked);
                    });
                });
            }
        }

        /**
         * ==========================================
         * 2. LOGGER CLASS
         * ==========================================
         */
        class Logger {
            constructor() {
                this.consoleEl = document.getElementById('logConsole');
            }

            log(msg, type = 'info') {
                const time = new Date().toLocaleTimeString('ar-EG');
                const div = document.createElement('div');
                div.className = 'log-entry';

                let typeClass = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : 'log-info');
                div.innerHTML = `<span style="color:#aaa">[${time}]</span> <span class="${typeClass}">${msg}</span>`;

                this.consoleEl.appendChild(div);
                this.consoleEl.scrollTop = this.consoleEl.scrollHeight;
            }

            clear() {
                this.consoleEl.innerHTML = '';
            }
        }

        /**
         * ==========================================
         * 3. FUEL ENGINE (LOGIC CORE)
         * ==========================================
         */
        class FuelEngine {
            constructor(logger) {
                this.logger = logger;
                this.settings = {};
            }

            loadSettings() {
                this.settings = {
                    chngminut: document.getElementById('chkMinutes').checked ? parseFloat(document.getElementById('valMinutes').value) : null,
                    qtymore: document.getElementById('chkQty').checked ? parseFloat(document.getElementById('valQty').value) : 50,
                    offhliday: document.getElementById('chkHoliday').checked,
                    fuelcap: document.getElementById('chkTank').checked,
                    divinat: document.getElementById('chkDivinat').checked
                };
                this.logger.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.");
            }

            /**
             * Parse date smartly (Excel Serial Number OR Custom String)
             */
            parseSmartDate(inputVal) {
                try {
                    if (!inputVal) return null;

                    // CASE 1: Excel Serial Number (e.g., 45184.45)
                    if (typeof inputVal === 'number') {
                        // Excel base date logic
                        const date = new Date(Math.round((inputVal - 25569) * 86400 * 1000));
                        // Validate
                        if (isNaN(date.getTime())) return null;
                        return date;
                    }

                    // CASE 2: String "18/10/2025 11:55 PM"
                    if (typeof inputVal === 'string') {
                        const parts = inputVal.trim().split(' ');
                        if (parts.length < 2) return null;

                        const dParts = parts[0].split('/'); // [18, 10, 2025]
                        const tParts = parts[1].split(':'); // [11, 55]

                        if (dParts.length < 3) return null;

                        let hours = parseInt(tParts[0]);
                        const minutes = parseInt(tParts[1]);
                        const ampm = parts[2] ? parts[2].toUpperCase() : '';

                        if (ampm === 'PM' && hours < 12) hours += 12;
                        if (ampm === 'AM' && hours === 12) hours = 0;
                        //here split date parts
                        // Math.round((inputVal - 25569) * 86400 * 1000)
                        const date = new Date(dParts[2], dParts[1] - 1, dParts[0], hours, minutes);
                        if (isNaN(date.getTime())) return null;
                        //const date = new Date(Math.round((dateb.getTime() - 25569) * 86400 * 1000));
                        // Final Check

                        return date;
                        // ØªØ­ÙˆÙŠÙ„ JS Date Ø¥Ù„Ù‰ Excel serial
                        //return ((date.getTime() / 86400000) + 25569).toFixed(5);
                    }

                    return null;
                } catch (e) {
                    return null;
                }
            }

            async process(file) {
                try {
                    this.loadSettings();
                    this.logger.log("Ø¨Ø¯Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...");

                    const buffer = await file.arrayBuffer();
                    const workbook = XLSX.read(buffer, {
                        type: 'array'
                    });

                    const mainSheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[mainSheetName], {
                        header: 1
                    });

                    this.logger.log(`ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${rawData.length} ØµÙ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù….`);

                    // 2. Clean Data
                    let cleanData = [];

                    for (let i = 0; i < rawData.length; i++) {
                        const row = rawData[i];
                        // Filter: Check if row is mostly empty or contains 'page'
                        if (!row || row.length < 10) continue;
                        if (row[16] && String(row[16]).toLowerCase().includes('page')) continue;

                        try {
                            // Try parsing date safely
                            let dateObj = this.parseSmartDate(row[7]);
                            if (!dateObj) continue; // Skip invalid dates silently
                            //dateObj = ((dateObj.getTime() / 86400000) + 25569).toFixed(5);
                            const qty = Math.round(parseFloat(row[15]) || 0);
                            const val = parseFloat(row[14]) || 0;

                            cleanData.push({
                                _rawDate: dateObj, // Date Object date.getTime() / 86400000) + 25569).toFixed(5);
                                m: row[16],
                                qty: qty,
                                val: val,
                                stationCode: String(row[13] || ""),
                                stationName: row[11],
                                transId: row[10],
                                card: String(row[8] || ""),
                                dateStr: dateObj, //.toLocaleString('en-GB'), // Keep as Date Object for now
                                product: row[6],
                                pos: row[5],
                                plate: row[2] ? String(row[2]).trim() : "",
                                chassis: row[1]
                            });
                        } catch (rowError) {
                            // Catch row-specific errors so process doesn't stop
                            console.warn("Skipped row due to error:", rowError);
                        }
                    }
                    this.logger.log(`ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${cleanData.length} Ø³Ø¬Ù„ Ù†Ø¸ÙŠÙ.`);

                    // 3. Prepare Logic Sheets
                    const sheets = {};
                    /*
                                        sheets['Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¸ÙŠÙØ©'] = cleanData.map(r => ({
                                            "Ù…": r.m,
                                            "ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù": r.qty,
                                            "Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ±Ù": r.val, //.toLocaleString(), // Keep as number for sorting
                                            "ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø·Ø©": r.stationCode,
                                            "Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©": r.stationName,
                                            "Ø±Ù‚Ù… Ø§Ù„Ø­Ø±ÙƒØ©": r.transId,
                                            "Ø±Ù‚Ù… Ø§Ù„ÙƒØ±Øª": r.card,
                                            "Ø§Ù„ØªØ§Ø±ÙŠØ®": r.dateStr.getDay(),
                                            "Ø§Ù„ÙˆÙ‚Øª": r.dateStr.getSeconds(), //((r.dateStr.getTime() / 86400000) + 25569.0833333333), //.getTime() / 86400000) + 25569).toFixed(5)
                                            "Ø§Ù„Ù…Ù†ØªØ¬": r.product,
                                            "ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‚Ø·Ø©": r.pos,
                                            "Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©": r.plate,
                                            "Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡": r.chassis
                                        }));
                    */
                    sheets['Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¸ÙŠÙØ©'] = cleanData.map(this.mapToOutput);




                    // B. No Plate
                    sheets['ØµØ±Ù Ø¨Ø¯ÙˆÙ† Ù„ÙˆØ­Ø©'] = sheets['Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¸ÙŠÙØ©'].filter(r => !r["Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©"]);

                    // C. Weekends (Fri/Sat)
                    sheets['ØµØ±Ù ÙÙŠ Ø§Ø¬Ø§Ø²Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©'] = cleanData.filter(r => {
                        const day = r._rawDate.getDay();
                        return day === 5 || day === 6;
                    }).map(this.mapToOutput);

                    // D. Official Holidays (Crash Fix here with Try-Catch)
                    let holidays = [];
                    if (this.settings.offhliday && workbook.Sheets['Ø§Ø¬Ø§Ø²Ø§Øª']) {
                        const hData = XLSX.utils.sheet_to_json(workbook.Sheets['Ø§Ø¬Ø§Ø²Ø§Øª']);
                        // Assuming holiday sheet date format needs parsing too
                        holidays = hData.map(h => {
                            const d = this.parseSmartDate(h['Ø§Ù„ØªØ§Ø±ÙŠØ®']);
                            return d ? {
                                date: d.toISOString().split('T')[0],
                                reason: h['Ø§Ù„Ø³Ø¨Ø¨']
                            } : null;
                        }).filter(h => h);
                    }

                    sheets['ØµØ±Ù ÙÙŠ Ø§Ø¬Ø§Ø²Ø§Øª Ø±Ø³Ù…ÙŠØ©'] = cleanData.map(r => {
                        try {
                            // Safe Check before toISOString
                            if (!r._rawDate || isNaN(r._rawDate.getTime())) return null;

                            const dStr = r._rawDate.toISOString().split('T')[0];
                            const holiday = holidays.find(h => h.date === dStr);
                            if (holiday) return {...this.mapToOutput(r),
                                "Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¬Ø§Ø²Ø©": holiday.reason
                            };
                        } catch (e) {
                            return null;
                        }
                        return null;
                    }).filter(i => i);

                    // E. Excess Quantity
                    sheets['ØµØ±Ù ÙƒÙ…ÙŠØ§Øª Ø²Ø§Ø¦Ø¯Ø©'] = cleanData
                        .filter(r => r.qty >= this.settings.qtymore)
                        .sort((a, b) => b.qty - a.qty)
                        .map(this.mapToOutput);

                    // F. Repeated Usage


                    /*
                                        if (this.settings.chngminut) {
                                            const repeats = [];
                                            cleanData.sort((a, b) => a.plate.localeCompare(b.plate) || a._rawDate - b._rawDate);

                                            for (let i = 0; i < cleanData.length - 1; i++) {
                                                if (cleanData[i].plate === cleanData[i + 1].plate) {
                                                    const diffMs = cleanData[i + 1]._rawDate - cleanData[i]._rawDate;
                                                    const diffMin = diffMs / 1000 / 60;
                                                    if (diffMin <= this.settings.chngminut) {
                                                        repeats.push({...this.mapToOutput(cleanData[i]), //****
                                                            "Ø§Ù„ØªÙƒØ±Ø§Ø± Ø®Ù„Ø§Ù„ (Ø¯Ù‚ÙŠÙ‚Ø©)": diffMin.toFixed(1)
                                                        });
                                                    }
                                                }
                                            }

                    */
                    // ØªØ£ÙƒØ¯ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ø«Ù… Ø§Ù„ØªØ§Ø±ÙŠØ®

                    /*
                    const dayMap = {};
                    cleanData.forEach(r => {
                        const k = r.plate + '_' + r._rawDate.toDateString();
                        dayMap[k] = (dayMap[k] || 0) + 1;
                    });
                    sheets['ØªÙƒØ±Ø§Ø± ØµØ±Ù ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…'] = cleanData
                        .filter(r => dayMap[r.plate + '_' + r._rawDate.toDateString()] > 1)
                        .map(r => ({...this.mapToOutput(r),
                            "Ù…Ø±Ø§Øª Ø§Ù„ØªÙƒØ±Ø§Ø±": dayMap[r.plate + '_' + r._rawDate.toDateString()]
                        }));
*/




                    // 1. ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØªÙŠÙ†
                    const withPlate = cleanData.filter(item => item.plate && item.plate.trim() !== "");
                    const withoutPlate = cleanData.filter(item => !item.plate || item.plate.trim() === "");

                    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ (withPlate)
                    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ plate Ø«Ù… dateStr
                    withPlate.sort((a, b) => {
                        if (a.plate !== b.plate) {
                            return a.plate.localeCompare(b.plate);
                        }
                        return new Date(a.dateStr) - new Date(b.dateStr);
                    });

                    // ØªØ¬Ù…ÙŠØ¹ ÙˆØ¹Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    const plateGroups = {};
                    withPlate.forEach(item => {
                        const dateOnly = new Date(item.dateStr).toISOString().slice(0, 10);
                        const key = `${item.plate}_${dateOnly}`;

                        if (!plateGroups[key]) {
                            plateGroups[key] = {
                                count: 0,
                                items: []
                            };
                        }

                        plateGroups[key].count++;
                        plateGroups[key].items.push(item);
                    });

                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    const duplicatePlates = Object.entries(plateGroups)
                        .filter(([key, group]) => group.count > 1)
                        .reduce((acc, [key, group]) => {
                            acc[key] = group;
                            return acc;
                        }, {});

                    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (withoutPlate)
                    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ card Ø«Ù… dateStr
                    withoutPlate.sort((a, b) => {
                        if (a.card !== b.card) {
                            return a.card.localeCompare(b.card);
                        }
                        return new Date(a.dateStr) - new Date(b.dateStr);
                    });

                    // ØªØ¬Ù…ÙŠØ¹ ÙˆØ¹Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
                    const cardGroups = {};
                    withoutPlate.forEach(item => {
                        const dateOnly = new Date(item.dateStr).toISOString().slice(0, 10);
                        const key = `${item.card}_${dateOnly}`;

                        if (!cardGroups[key]) {
                            cardGroups[key] = {
                                count: 0,
                                items: []
                            };
                        }

                        cardGroups[key].count++;
                        cardGroups[key].items.push(item);
                    });

                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
                    const duplicateCards = Object.entries(cardGroups)
                        .filter(([key, group]) => group.count > 1)
                        .reduce((acc, [key, group]) => {
                            acc[key] = group;
                            return acc;
                        }, {});

                    // 4. Ø¯Ù…Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                    const finalResults = {
                        duplicatePlates: duplicatePlates,
                        duplicateCards: duplicateCards,
                        allDuplicates: {
                            ...duplicatePlates,
                            ...duplicateCards
                        }
                    };

                    sheets['ØªÙƒØ±Ø§Ø± ØµØ±Ù ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…'] = finalResults.allDuplicates ? Object.values(finalResults.allDuplicates).flatMap(g => g.items.map(r => this.mapToOutput(r))) : [];


                    //**********************************




                    //****************************************************

                    if (this.settings.chngminut) {

                        // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªÙƒØ±Ø§Ø±Ù‡Ø§ (Ø§Ù„ØªÙŠ Ø³ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ true)
                        const processedRecords = [];
                        // Ù‚Ø§Ù…ÙˆØ³ Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù„ÙˆØ­Ø© Ø£Ùˆ Ø§Ù„ÙƒØ±Øª
                        const groups = {};

                        // 1ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ

                        cleanData.forEach(r => {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Date
                            const dateObj = (r._rawDate instanceof Date) ? r._rawDate : new Date(r._rawDate);

                            // **[ØªØ¹Ø¯ÙŠÙ„ 1]** ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ù…Ø³Ù„Ø³Ù„ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Serial Minute Number) Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                            // (Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù†Ø° Epoch - 1970/01/01)
                            const minuteSerial = Math.floor(dateObj.getTime() / 60000);

                            // **[ØªØ¹Ø¯ÙŠÙ„ 2]** ØªØ­Ø¯ÙŠØ¯ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ¬Ù…ÙŠØ¹: Ø§Ù„Ù„ÙˆØ­Ø© (Plate) Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„ÙƒØ±Øª (Card) Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø§Ù„Ù„ÙˆØ­Ø©
                            const groupingKey = (r.plate && r.plate !== "") ? r.plate : r.card;

                            // **[ØªØ¹Ø¯ÙŠÙ„ 3]** Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù…Ù†Ø·Ù‚ÙŠ (isRepeat) Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ 'false'
                            const record = {
                                ...r,
                                _rawDate: dateObj,
                                _minuteSerial: minuteSerial,
                                isRepeat: false, // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            };

                            if (!groups[groupingKey]) groups[groupingKey] = [];
                            groups[groupingKey].push(record);
                        });

                        // 2ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§ ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©

                        Object.keys(groups).forEach(key => {
                            let records = groups[key];

                            // **[ØªØ¹Ø¯ÙŠÙ„ 4]** Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØµØ§Ø¹Ø¯ÙŠ Ø­Ø³Ø¨ Ù…Ø³Ù„Ø³Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)
                            records = records.sort((a, b) => a._minuteSerial - b._minuteSerial);

                            // 3ï¸âƒ£ Ù…Ù‚Ø§Ø±Ù†Ø© ÙØ§Ø±Ù‚ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨ÙŠÙ† Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø· (i Ù…Ø¹ i+1)
                            for (let i = 0; i < records.length; i++) {
                                const currentRecord = records[i];
                                const nextRecord = records[i + 1];

                                // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙ ØªØ§Ù„ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                                if (nextRecord) {

                                    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                                    const diffMin = nextRecord._minuteSerial - currentRecord._minuteSerial;

                                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£Ù‚Ù„ Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (chngminut)
                                    if (diffMin <= this.settings.chngminut) {

                                        // **[ØªØ¹Ø¯ÙŠÙ„ 5]** ÙˆØ¶Ø¹ TRUE ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ Ù„Ù„ØµÙÙŠÙ† (Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„ØªØ§Ù„ÙŠ)
                                        currentRecord.isRepeat = true;
                                        nextRecord.isRepeat = true;

                                    } else {
                                        // **[ØªØ¹Ø¯ÙŠÙ„ 6]** Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªÙƒØ±Ø§Ø±ØŒ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ (records[i]) ÙŠØ¨Ù‚Ù‰ false 
                                        // Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ (records[i+1]) Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø³Ø§Ø¨Ù‚ØŒ Ø³ÙŠØ¨Ù‚Ù‰ false
                                        // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ÙƒØªØ§Ø¨Ø© false ØµØ±ÙŠØ­Ø©ØŒ ÙÙ‚Ø· Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ Ù„ÙŠØ³ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† ØªÙƒØ±Ø§Ø± Ø³Ø§Ø¨Ù‚
                                        // (Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ ØªØ­Ù‚Ù‚ Ø¶Ù…Ù†ÙŠ Ù„Ø£Ù† isRepeat Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ falseØŒ ÙˆØ§Ù„Ø´Ø±Ø· ÙŠÙƒØªØ¨ true ÙÙ‚Ø·)
                                    }
                                }
                            }

                            // **[ØªØ¹Ø¯ÙŠÙ„ 7]** Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙŠ ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© true Ø¹Ù„ÙŠÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                            processedRecords.push(...records.filter(r => r.isRepeat));
                        });

                        // ... (Ø§Ù„Ø®Ø·ÙˆØ§Øª 1 Ùˆ 2 Ùˆ 3 ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)

                        // 4ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©

                        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© true Ø¹Ù„ÙŠÙ‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                        processedRecords.sort((a, b) => a._rawDate - b._rawDate);

                        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ù„Ù„Ø´ÙŠØª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                        const repeatsOutput = processedRecords.map((r, index, array) => {

                            // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø§Ù„Ù„ÙˆØ­Ø© Ø£Ùˆ Ø§Ù„ÙƒØ±Øª)
                            const currentKey = (r.plate && r.plate !== "") ? r.plate : r.card;

                            let diffMin = "---";

                            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙŠ ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„ÙŠÙ‡Ø§
                            if (index > 0) {
                                const prevR = array[index - 1];
                                const prevKey = (prevR.plate && prevR.plate !== "") ? prevR.plate : prevR.card;

                                // Ø§Ù„ØªØ­Ù‚Ù‚: Ù‡Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…ØŸ
                                if (prevKey === currentKey && prevR.dayOnly === r.dayOnly) {

                                    // Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø©
                                    const calculatedDiff = r._minuteSerial - prevR._minuteSerial;
                                    diffMin = calculatedDiff.toFixed(1);
                                }
                            }

                            return {
                                ...this.mapToOutput(r),
                                "Ø§Ù„ØªÙƒØ±Ø§Ø± Ø®Ù„Ø§Ù„ (Ø¯Ù‚ÙŠÙ‚Ø©)": diffMin

                                /*, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ§Ø±Ù‚ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨
                                "Ø§Ù„ÙŠÙˆÙ…": r.dayOnly,
                                "Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ¬Ù…ÙŠØ¹": currentKey,
                                "Ø­Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±": r.isRepeat ? "Ù…ØªÙƒØ±Ø±" : "---"
                                */
                            };
                        });

                        // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                        sheets['ØªÙƒØ±Ø§Ø± ØµØ±Ù ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚'] = repeatsOutput;
                    }







                    /*
                                            cleanData.sort((a, b) => {
                                                if (a.plate === b.plate) {
                                                    return a._rawDate - b._rawDate;
                                                }
                                                return a.plate.localeCompare(b.plate);
                                            });

                                            const repeats = [];

                                            for (let i = 0; i < cleanData.length - 1; i++) {

                                                const curr = cleanData[i];
                                                const next = cleanData[i + 1];

                                                // 1ï¸âƒ£ Ù†ÙØ³ Ø§Ù„Ù„ÙˆØ­Ø©
                                                if (curr.plate !== next.plate) continue;

                                                // 2ï¸âƒ£ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
                                                const sameDay =
                                                    curr._rawDate.getFullYear() === next._rawDate.getFullYear() &&
                                                    curr._rawDate.getMonth() === next._rawDate.getMonth() &&
                                                    curr._rawDate.getDate() === next._rawDate.getDate();

                                                if (!sameDay) continue;

                                                // 3ï¸âƒ£ ÙØ§Ø±Ù‚ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
                                                const diffMinutes = (next._rawDate - curr._rawDate) / 1000 / 60;

                                                if (diffMinutes <= this.settings.chngminut) {

                                                    repeats.push({
                                                        ...this.mapToOutput(curr),
                                                        "Ø§Ù„ØªÙƒØ±Ø§Ø± Ø®Ù„Ø§Ù„ (Ø¯Ù‚ÙŠÙ‚Ø©)": diffMinutes.toFixed(1),
                                                        "Ø§Ù„ØªØ§Ø±ÙŠØ®": curr._rawDate,
                                                    });
                                                }
                                            }

                    */


                    // G. Tank Capacity
                    if (this.settings.fuelcap && workbook.Sheets['ØªØ§Ù†Ùƒ']) {
                        const tankData = XLSX.utils.sheet_to_json(workbook.Sheets['ØªØ§Ù†Ùƒ']);
                        const tankMap = {};
                        tankData.forEach(t => tankMap[String(t['Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ù‡']).trim()] = {
                            cap: t['Ø³Ø¹Ù‡ Ø§Ù„ØªØ§Ù†Ùƒ'],
                            type: t['Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ù‡']
                        });

                        sheets['ØµØ±Ù Ø§ÙƒØ¨Ø± Ù…Ù† Ø³Ø¹Ø© Ø§Ù„ØªØ§Ù†Ùƒ'] = cleanData.map(r => {
                            const info = tankMap[r.plate];
                            if (info && r.qty > info.cap) {
                                return {
                                    ...this.mapToOutput(r),
                                    "Ø³Ø¹Ø© Ø§Ù„ØªØ§Ù†Ùƒ": info.cap,
                                    "ÙƒÙ…ÙŠØ© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©": r.qty - info.cap,
                                    "Ù†Ø³Ø¨Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©": ((r.qty - info.cap) / info.cap * 100).toFixed(1) + '%',
                                    "Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©": info.type
                                };
                            }
                            return null;
                        }).filter(i => i).sort((a, b) => b["ÙƒÙ…ÙŠØ© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©"] - a["ÙƒÙ…ÙŠØ© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©"]);
                    }

                    // H. Decommissioning
                    if (this.settings.divinat && workbook.Sheets['ØªÙƒÙ‡ÙŠÙ†']) {
                        const divData = XLSX.utils.sheet_to_json(workbook.Sheets['ØªÙƒÙ‡ÙŠÙ†']);
                        const divMap = {};
                        divData.forEach(d => {
                            const date = this.parseSmartDate(d['Ø§Ù„ØªØ§Ø±ÙŠØ®']);
                            if (date) divMap[String(d['Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ù‡']).trim()] = date;
                        });

                        sheets['ØµØ±Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªÙƒÙ‡ÙŠÙ†'] = cleanData.filter(r => {
                            const dDate = divMap[r.plate];
                            if (dDate) return r._rawDate > dDate;
                            return false;
                        }).map(this.mapToOutput)
                    }

                    // I. Pivots
                    sheets['Ù…Ø¬Ù…Ø¹ Ø³ÙŠØ§Ø±Ø§Øª'] = this.createPivot(cleanData, 'plate', 'Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©');
                    sheets['Ù…Ø¬Ù…Ø¹ Ù…Ø­Ø·Ø§Øª'] = this.createPivot(cleanData, 'stationName', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©');
                    sheets['Ù…Ø¬Ù…Ø¹ ÙƒØ±ÙˆØª'] = this.createPivot(cleanData, 'card', 'Ø±Ù‚Ù… Ø§Ù„ÙƒØ±Øª');

                    // J. Subtotals
                    cleanData.sort((a, b) => a.plate.localeCompare(b.plate) || b.qty - a.qty);
                    let subtotalRows = [];
                    let currentPlate = null;
                    let subQty = 0,
                        subVal = 0;

                    cleanData.forEach(r => {
                        if (currentPlate !== r.plate) {
                            if (currentPlate !== null) {
                                subtotalRows.push({
                                    "Ù…": "Ø§Ø¬Ù…Ø§Ù„ÙŠ",
                                    "Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©": currentPlate,
                                    "ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù": subQty,
                                    "Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ±Ù": subVal
                                });
                            }
                            currentPlate = r.plate;
                            subQty = 0;
                            subVal = 0;
                        }
                        subQty += r.qty;
                        subVal += r.val;
                        subtotalRows.push(this.mapToOutput(r));
                    });
                    if (currentPlate) subtotalRows.push({
                        "Ù…": "Ø§Ø¬Ù…Ø§Ù„ÙŠ",
                        "Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©": currentPlate,
                        "ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù": subQty,
                        "Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ±Ù": subVal
                    });

                    sheets['Ù…Ø¬Ø§Ù…ÙŠØ¹ ÙØ±Ø¹ÙŠØ© Ø³ÙŠØ§Ø±Ø§Øª'] = subtotalRows;
                    sheets['ÙÙ„ØªØ±Ø© Ø³ÙŠØ§Ø±Ø§Øª'] = sheets['Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¸ÙŠÙØ©'];

                    // 4. Generate Excel
                    this.generateExcel(sheets);

                } catch (err) {
                    this.logger.log(`Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${err.message}`, 'error');
                    console.error(err);
                }
            }

            // Helper: Map clean object to Arabic Output format
            mapToOutput(r) {
                return {
                    "Ù…": r.m,
                    "ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù": r.qty,
                    "Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ±Ù": r.val, //.toLocaleString(),
                    "ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø·Ø©": r.stationCode,
                    "Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©": r.stationName,
                    "Ø±Ù‚Ù… Ø§Ù„Ø­Ø±ÙƒØ©": r.transId,
                    "Ø±Ù‚Ù… Ø§Ù„ÙƒØ±Øª": r.card,
                    "Ø§Ù„ØªØ§Ø±ÙŠØ®": r.dateStr,
                    "Ø§Ù„Ù…Ù†ØªØ¬": r.product,
                    "ÙƒÙˆØ¯ Ø§Ù„Ù†Ù‚Ø·Ø©": r.pos,
                    "Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©": r.plate,
                    "Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡": r.chassis
                };
            }

            createPivot(data, keyField, keyName) {
                const map = {};
                data.forEach(r => {
                    const k = r[keyField] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    if (!map[k]) map[k] = {
                        qty: 0,
                        val: 0,
                        count: 0
                    };
                    map[k].qty += r.qty;
                    map[k].val += r.val;
                    map[k].count++;
                });

                return Object.keys(map).map((k, i) => ({
                    "Ù…Ø³Ù„Ø³Ù„": i + 1,
                    [keyName]: k,
                    "Ø§Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù": map[k].qty,
                    "Ø§Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ±Ù": map[k].val.toLocaleString()
                })).sort((a, b) => b["Ø§Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù"] - a["Ø§Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…ÙŠØ© Ø§Ù„ØµØ±Ù"]);
            }

            generateExcel(sheetsData) {
                this.logger.log("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...");
                const wb = XLSX.utils.book_new();
                wb.Workbook = {
                    Views: [{
                        RTL: true
                    }]
                };

                for (const [name, data] of Object.entries(sheetsData)) {
                    if (!data || data.length === 0) continue;

                    const headers = Object.keys(data[0]);

                    const wsData = [
                        [],
                        [], // 1, 2 Empty
                        ["", "", `ØªÙ‚Ø±ÙŠØ±: ${name}`], // 3 Title
                        ["", "", `Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${data.length}`], // 4 Count
                        [], // 5 Empty
                        headers // 6 Headers
                    ];

                    data.forEach(row => wsData.push(Object.values(row)));

                    const ws = XLSX.utils.aoa_to_sheet(wsData);

                    if (!ws['!views']) ws['!views'] = [];
                    ws['!views'].push({
                        RTL: true
                    });

                    const colWidths = headers.map(() => ({
                        wch: 15
                    }));
                    ws['!cols'] = colWidths;

                    XLSX.utils.book_append_sheet(wb, ws, name);
                }

                XLSX.writeFile(wb, "Smart_Fuel_Report_2025.xlsx");
                this.logger.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­! âœ…", 'success');
            }
        }

        /**
         * ==========================================
         * 4. INITIALIZATION
         * ==========================================
         */
        document.addEventListener('DOMContentLoaded', () => {
            AppConfig.init();

            const logger = new Logger();
            const engine = new FuelEngine(logger);

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const btn = document.getElementById('btnProcess');

            // Drag & Drop
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });

            fileInput.addEventListener('change', e => {
                if (e.target.files.length) handleFile(e.target.files[0]);
            });

            let currentFile = null;

            function handleFile(file) {
                currentFile = file;
                dropZone.querySelector('.drop-text').innerText = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù: ${file.name}`;
                logger.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name}`);
            }

            btn.addEventListener('click', () => {
                if (!currentFile) {
                    logger.log("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹", 'error');
                    return;
                }
                btn.disabled = true;
                btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";

                setTimeout(() => {
                    engine.process(currentFile).finally(() => {
                        btn.disabled = false;
                        btn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ ğŸš€";
                    });
                }, 100);
            });
        });
    </script>
</body>

</html>