<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©">
    
    <title>Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --weekend-bg: #dcfce7;
            --weekend-text: #166534;
            --holiday-bg: #fee2e2;
            --holiday-text: #991b1b;
            --border-color: #cbd5e1;
            --text-main: #0f172a;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 950px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 1px solid var(--border-color);
        }

        /* --- Header Styles --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            border-radius: 12px 12px 0 0;
        }

        .right-controls {
            display: flex;
            gap: 10px;
        }

        .month-year-display {
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 6px;
            user-select: none;
        }

        .month-year-display:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn.secondary {
            background-color: #64748b;
        }

        .nav-btn:hover {
            opacity: 0.9;
        }

        /* --- Year Selector --- */
        .year-selector {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
        }

        .year-selector.active {
            display: grid;
        }

        .year-option {
            padding: 10px;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
        }

        .year-option:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        /* --- Calendar Grid --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .day-name {
            background-color: #f1f5f9;
            padding: 15px 5px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .day-name:last-child { border-left: 1px solid var(--border-color); }

        .day-cell {
            min-height: 110px;
            padding: 8px;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            background: white;
        }
        
        .day-cell:nth-child(7n+1) { /* First column in row */ }
        .day-cell:nth-child(7n) { border-left: 1px solid var(--border-color); }

        .day-number {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
            display: block;
        }

        .day-content {
            font-size: 0.8rem;
            margin-top: 4px;
            line-height: 1.4;
        }

        /* --- Status Colors --- */
        .weekend {
            background-color: var(--weekend-bg);
            color: var(--weekend-text);
        }
        
        .official-holiday {
            background-color: var(--holiday-bg);
            color: var(--holiday-text);
            border: 1px solid #fca5a5;
        }

        .today {
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }

        .empty-cell {
            background-color: #fafafa;
        }

        /* --- Footer Controls --- */
        .footer-controls {
            padding: 20px;
            background-color: #fff;
            border-radius: 0 0 12px 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stats-row {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
            font-size: 1.05rem;
            text-align: center;
            line-height: 2;
        }

        .highlight-num {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            margin: 0 5px;
        }

        .input-days {
            width: 50px;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .final-balance {
            font-weight: 900;
            font-size: 1.3rem;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .balance-positive { color: #166534; background: #dcfce7; }
        .balance-negative { color: #991b1b; background: #fee2e2; }

        .file-upload-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .note {
            font-size: 0.85rem;
            color: #64748b;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="right-controls">
                <button class="nav-btn" id="nextMonth">Ø§Ù„ØªØ§Ù„ÙŠ &#10095;</button>
                <button class="nav-btn secondary" id="goToToday" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ">Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
            
            <div class="month-year-display" id="dateDisplay">
                <span id="monthName"></span>
                <span id="yearNum"></span>
            </div>
            
            <button class="nav-btn" id="prevMonth">&#10094; Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        </header>

        <div class="year-selector" id="yearSelector"></div>

        <div class="calendar-grid">
            <div class="day-name">Ø§Ù„Ø£Ø­Ø¯</div>
            <div class="day-name">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</div>
            <div class="day-name">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</div>
            <div class="day-name">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</div>
            <div class="day-name">Ø§Ù„Ø®Ù…ÙŠØ³</div>
            <div class="day-name">Ø§Ù„Ø¬Ù…Ø¹Ø©</div>
            <div class="day-name">Ø§Ù„Ø³Ø¨Øª</div>
        </div>

        <div class="calendar-grid" id="calendarBody"></div>

        <div class="footer-controls">
            
            <div class="stats-row">
                Ø±ØµÙŠØ¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø´Ù‡Ø± = 
                Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ© (<span id="actualWorkDays" class="highlight-num">0</span>) 
                - Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (<input type="number" id="requiredWorkDays" class="input-days" value="17">) 
                = <span id="monthBalance" class="final-balance">0</span>
            </div>

            <div class="file-upload-section">
                <label for="excelFile"><strong>ğŸ“‚ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Excel):</strong></label>
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <span class="note">(Ø§Ù„Ø¹Ù…ÙˆØ¯ 1: Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ 2: Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©)</span>
            </div>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        const monthNames = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        let currentDate = new Date();
        let officialHolidays = {}; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©
        let currentActualWorkDays = 0; // Ù„ØªØ®Ø²ÙŠÙ† Ù‚ÙŠÙ…Ø© Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ù†Ø¨ÙˆØª

        // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        const calendarBody = document.getElementById('calendarBody');
        const monthNameEl = document.getElementById('monthName');
        const yearNumEl = document.getElementById('yearNum');
        const yearSelector = document.getElementById('yearSelector');
        const dateDisplay = document.getElementById('dateDisplay');
        
        // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const actualWorkDaysEl = document.getElementById('actualWorkDays');
        const requiredWorkDaysInput = document.getElementById('requiredWorkDays');
        const monthBalanceEl = document.getElementById('monthBalance');

        // --- Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ ---
        function init() {
            renderCalendar();
            setupEventListeners();
            setupYearSelector();
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            monthNameEl.textContent = monthNames[month];
            yearNumEl.textContent = year;

            calendarBody.innerHTML = '';

            // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            const firstDayIndex = new Date(year, month, 1).getDay(); // 0=Sunday
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let workDaysCount = 0;

            // Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙØ§Ø±ØºØ© Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('day-cell', 'empty-cell');
                calendarBody.appendChild(emptyCell);
            }

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£ÙŠØ§Ù…
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.classList.add('day-cell');
                
                const currentDayDate = new Date(year, month, day);
                const dayOfWeek = currentDayDate.getDay(); // 0=Sun ... 6=Sat
                const dateString = formatDate(currentDayDate);

                // Ø§Ù„Ø±Ù‚Ù…
                const dayNumber = document.createElement('span');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);

                // ÙØ­Øµ Ø§Ù„Ø¹Ø·Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ø¬Ù…Ø¹Ø© ÙˆØ³Ø¨Øª)
                const isWeekend = (dayOfWeek === 5 || dayOfWeek === 6);
                
                // ÙØ­Øµ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ©
                let isOfficialHoliday = false;
                if (officialHolidays[dateString]) {
                    isOfficialHoliday = true;
                    
                    const holidayDiv = document.createElement('div');
                    holidayDiv.classList.add('day-content');
                    holidayDiv.textContent = `ğŸ‰ ${officialHolidays[dateString]}`;
                    cell.appendChild(holidayDiv);
                }

                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª (Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª)
                if (isWeekend) {
                    cell.classList.add('weekend');
                } else if (isOfficialHoliday) {
                    cell.classList.add('official-holiday');
                }

                // ØªØ¸Ù„ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }

                // Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„: (Ù„ÙŠØ³ Ø¬Ù…Ø¹Ø©/Ø³Ø¨Øª) Ùˆ (Ù„ÙŠØ³ Ø¥Ø¬Ø§Ø²Ø© Ø±Ø³Ù…ÙŠØ©)
                if (!isWeekend && !isOfficialHoliday) {
                    workDaysCount++;
                }

                calendarBody.appendChild(cell);
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©
            currentActualWorkDays = workDaysCount;
            calculateBalance();
        }

        // --- Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ (ØªÙØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù… Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ù†Ø¨ÙˆØª) ---
        function calculateBalance() {
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ùˆ 0 Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©)
            const requiredDays = parseInt(requiredWorkDaysInput.value) || 0;
            
            // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©
            const balance = currentActualWorkDays - requiredDays;

            // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            actualWorkDaysEl.textContent = currentActualWorkDays;
            monthBalanceEl.textContent = balance;

            // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø©
            monthBalanceEl.className = 'final-balance'; // reset
            if (balance >= 0) {
                monthBalanceEl.classList.add('balance-positive');
            } else {
                monthBalanceEl.classList.add('balance-negative');
            }
        }

        // --- Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Listeners) ---
        function setupEventListeners() {
            // Ø§Ù„ØªÙ†Ù‚Ù„
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Ø²Ø± "Ø§Ù„ÙŠÙˆÙ…" - Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            document.getElementById('goToToday').addEventListener('click', () => {
                currentDate = new Date(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„ÙŠÙˆÙ…
                renderCalendar();
            });

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª
            dateDisplay.addEventListener('click', (e) => {
                e.stopPropagation();
                yearSelector.classList.toggle('active');
            });
            document.addEventListener('click', () => {
                yearSelector.classList.remove('active');
            });

            // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± "Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©" ÙŠØ¯ÙˆÙŠØ§Ù‹
            requiredWorkDaysInput.addEventListener('input', calculateBalance);

            // Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„
            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª
        function setupYearSelector() {
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 10; y <= currentYear + 10; y++) {
                const div = document.createElement('div');
                div.textContent = y;
                div.classList.add('year-option');
                div.addEventListener('click', () => {
                    currentDate.setFullYear(y);
                    renderCalendar();
                });
                yearSelector.appendChild(div);
            }
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ ---
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                officialHolidays = {}; // ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…

                // Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row[0]) {
                        let dateStr;
                        if (row[0] instanceof Date) {
                            dateStr = formatDate(row[0]);
                        } else {
                            const d = new Date(row[0]);
                            if(!isNaN(d)) dateStr = formatDate(d);
                        }

                        if (dateStr) {
                            officialHolidays[dateStr] = row[1] || "Ø¥Ø¬Ø§Ø²Ø©";
                        }
                    }
                }
                alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.');
                renderCalendar();
            };
            reader.readAsArrayBuffer(file);
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® YYYY-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        init();

    </script>
</body>
</html>
